{% extends 'dashboard/base.html' %}

{% block title %}Dashboard Overview - Trading Oracle{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-3xl font-bold text-gray-900">Dashboard Overview</h2>
        <p class="mt-1 text-sm text-gray-600">Real-time system performance and statistics</p>
    </div>
    <div>
        <button
            id="run-analysis-btn"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
            <i class="fas fa-play mr-2"></i>
            Run Analysis
        </button>
    </div>
</div>

<!-- Key Metrics Cards -->
<div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8">
    <!-- Total Decisions -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="rounded-md bg-indigo-500 p-3">
                        <i class="fas fa-chart-line text-white text-2xl"></i>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Decisions</dt>
                        <dd class="text-3xl font-semibold text-gray-900">{{ total_decisions|default:0 }}</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-3">
            <div class="text-sm">
                <span class="font-medium text-indigo-600">{{ decisions_24h|default:0 }}</span>
                <span class="text-gray-500">in last 24h</span>
            </div>
        </div>
    </div>

    <!-- Active Symbols -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="rounded-md bg-green-500 p-3">
                        <i class="fas fa-coins text-white text-2xl"></i>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Active Symbols</dt>
                        <dd class="text-3xl font-semibold text-gray-900">{{ active_symbols|default:0 }}</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-3">
            <div class="text-sm text-gray-500">
                Currently tracking
            </div>
        </div>
    </div>

    <!-- Average Confidence -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="rounded-md bg-yellow-500 p-3">
                        <i class="fas fa-percentage text-white text-2xl"></i>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">Avg Confidence</dt>
                        <dd class="text-3xl font-semibold text-gray-900">{{ avg_confidence|default:0 }}%</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-3">
            <div class="text-sm text-gray-500">
                System confidence level
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="rounded-md bg-emerald-500 p-3">
                        <i class="fas fa-check-circle text-white text-2xl"></i>
                    </div>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">System Status</dt>
                        <dd class="text-2xl font-semibold text-emerald-600">Operational</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-3">
            <div class="text-sm text-gray-500">
                All systems running
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Decision Timeline Chart -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-area mr-2 text-indigo-600"></i>
            Decision Timeline (Last 30 Days)
        </h3>
        <canvas id="decisionTimelineChart" height="300"></canvas>
    </div>

    <!-- Confidence Distribution -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-chart-pie mr-2 text-green-600"></i>
            Confidence Distribution
        </h3>
        <canvas id="confidenceChart" height="300"></canvas>
    </div>
</div>

<!-- Signal Distribution & Top Symbols -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Signal Distribution -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-signal mr-2 text-purple-600"></i>
            Signal Distribution (Last 7 Days)
        </h3>
        <div class="space-y-3">
            {% for signal in signal_distribution %}
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="signal-{{ signal.signal }} px-3 py-1 rounded-md text-sm font-medium">
                        {{ signal.signal }}
                    </span>
                </div>
                <div class="flex items-center">
                    <span class="text-gray-700 font-semibold mr-2">{{ signal.count }}</span>
                    <div class="w-32 bg-gray-200 rounded-full h-2">
                        {% widthratio signal.count total_decisions 100 as percent %}
                        <div class="bg-indigo-600 h-2 rounded-full" style="width: {{ percent }}%"></div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-sm">No signals in the last 7 days</p>
            {% endfor %}
        </div>
    </div>

    <!-- Top Symbols -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-trophy mr-2 text-yellow-600"></i>
            Top Symbols (Last 7 Days)
        </h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Decisions</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Conf.</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for symbol in top_symbols %}
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ symbol.symbol__symbol }}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">
                            {{ symbol.count }}
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">
                            <span class="font-semibold">{{ symbol.avg_confidence|floatformat:1 }}%</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="px-3 py-2 text-sm text-gray-500 text-center">No data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Recent Decisions -->
<div class="bg-white shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-clock mr-2 text-blue-600"></i>
            Recent Decisions
        </h3>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TF</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Signal</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entry</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for decision in recent_decisions %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ decision.timestamp|date:"M d, H:i" }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {{ decision.symbol.symbol }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        {{ decision.timeframe.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="signal-{{ decision.signal }} px-2 py-1 rounded text-xs font-semibold">
                            {{ decision.signal }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex items-center">
                            <span class="font-semibold mr-2">{{ decision.confidence }}%</span>
                            <div class="w-20 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: {{ decision.confidence }}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        {% if decision.entry_price %}
                            ${{ decision.entry_price|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <a href="{% url 'dashboard:decision_detail' decision.id %}"
                           class="text-indigo-600 hover:text-indigo-900">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-sm text-gray-500">
                        No recent decisions
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
        <a href="{% url 'dashboard:history' %}" class="text-indigo-600 hover:text-indigo-900 text-sm font-medium">
            View All Decisions <i class="fas fa-arrow-right ml-1"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Decision Timeline Chart
    fetch('{% url "dashboard:api_decision_chart" %}?days=30')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('decisionTimelineChart').getContext('2d');

            // Assign colors to signals
            const signalColors = {
                'STRONG_BUY': '#16a34a',
                'BUY': '#22c55e',
                'WEAK_BUY': '#86efac',
                'NEUTRAL': '#9ca3af',
                'WEAK_SELL': '#fca5a5',
                'SELL': '#ef4444',
                'STRONG_SELL': '#dc2626'
            };

            const datasets = data.datasets.map(ds => ({
                label: ds.label,
                data: ds.data,
                backgroundColor: signalColors[ds.label] || '#9ca3af',
                borderColor: signalColors[ds.label] || '#9ca3af',
                borderWidth: 1
            }));

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        });

    // Confidence Distribution Chart
    fetch('{% url "dashboard:api_confidence_chart" %}?days=30')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('confidenceChart').getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.data,
                        backgroundColor: [
                            '#ef4444',
                            '#f97316',
                            '#eab308',
                            '#84cc16',
                            '#22c55e',
                            '#10b981'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        });

    // Run Analysis Button Handler
    document.getElementById('run-analysis-btn').addEventListener('click', async function() {
        const button = this;
        const originalText = button.innerHTML;

        // Disable button and show loading state
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running Analysis...';

        try {
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

            const response = await fetch('{% url "dashboard:api_run_analysis" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'symbols[]': ['BTCUSDT', 'XAUUSD'],
                    'timeframes[]': ['1h', '4h', '1d'],
                    'market_types[]': ['SPOT']
                })
            });

            const data = await response.json();

            if (data.success) {
                // Show success message
                alert(`Analysis complete!\nDecisions created: ${data.decisions_created}\nErrors: ${data.errors.length}`);

                // Reload page to show new data
                location.reload();
            } else {
                alert(`Error: ${data.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error running analysis:', error);
            alert(`Error running analysis: ${error.message}`);
        } finally {
            // Re-enable button
            button.disabled = false;
            button.innerHTML = originalText;
        }
    });
</script>
{% endblock %}
